# 项目架构文档

## 概述

科大讯飞WebAPI SDK是一个现代化的语音处理解决方案，提供语音识别、语音合成等核心功能。本文档详细描述了项目的整体架构、设计原则和核心组件。

## 架构图

```
┌─────────────────────────────────────────────────────────────┐
│                    前端应用层                                │
├─────────────────────────────────────────────────────────────┤
│  React Hooks  │  Vue 2/3  │  原生 JavaScript  │  其他框架   │
├─────────────────────────────────────────────────────────────┤
│                    SDK 核心层                               │
├─────────────────────────────────────────────────────────────┤
│  IatClient  │  TtsClient  │  RtasrClient  │  DtsClient     │
├─────────────────────────────────────────────────────────────┤
│                   基础服务层                                │
├─────────────────────────────────────────────────────────────┤
│  BaseXfyunClient  │  音频处理  │  错误处理  │  工具函数     │
├─────────────────────────────────────────────────────────────┤
│                   网络通信层                                │
├─────────────────────────────────────────────────────────────┤
│  WebSocket  │  HTTP  │  签名获取  │  重试机制  │  连接池     │
├─────────────────────────────────────────────────────────────┤
│                   后端服务层                                │
├─────────────────────────────────────────────────────────────┤
│  xfyun-webapi (Spring Boot)  │  签名生成  │  API密钥管理   │
├─────────────────────────────────────────────────────────────┤
│                   讯飞API服务                               │
├─────────────────────────────────────────────────────────────┤
│  IAT  │  TTS  │  RTASR  │  DTS  │  其他讯飞服务            │
└─────────────────────────────────────────────────────────────┘
```

## 核心设计原则

### 1. 模块化设计
- 每个功能模块独立封装
- 清晰的接口定义
- 低耦合高内聚

### 2. 多框架支持
- 统一的底层实现
- 框架特定的适配层
- 一致的API体验

### 3. 类型安全
- 完整的TypeScript类型定义
- 编译时类型检查
- 智能代码提示

### 4. 性能优化
- 音频处理优化
- 内存管理
- 连接池管理

### 5. 错误处理
- 统一的错误处理机制
- 详细的错误信息
- 自动重试策略

## 核心组件

### 1. BaseXfyunClient

**职责**: 提供所有客户端的通用功能

**核心功能**:
- 统一的签名获取
- 错误处理机制
- 状态管理
- 日志记录

**关键方法**:
```typescript
abstract class BaseXfyunClient<T extends BaseXfyunClientOptions> {
  protected async getSignature(type: string): Promise<any>
  protected handleError(message: string, sid?: string): void
  protected processXfyunError(code?: number, message?: string): string
  public reset(): void
  public close(): void
}
```

### 2. 客户端实现

#### IatClient (语音听写)
- **协议**: WebSocket
- **功能**: 实时语音转文字
- **特点**: 支持增量识别、动态修正

#### TtsClient (语音合成)
- **协议**: WebSocket
- **功能**: 文字转语音
- **特点**: 支持多种音频格式、实时播放

#### RtasrClient (实时语音转写)
- **协议**: WebSocket
- **功能**: 长时间语音识别
- **特点**: 连接池管理、高并发支持

#### DtsClient (长文本语音合成)
- **协议**: HTTP
- **功能**: 长文本语音合成
- **特点**: 异步任务处理、结果下载

### 3. 框架适配层

#### React Hooks
```typescript
// 使用示例
const { status, error, open, sendFrame, close } = useIat({
  serverBase: 'http://localhost:8083',
  getAuthCode: () => 'your-token',
  onResult: (text, isFinal) => console.log(text)
});
```

#### Vue 组合式API
```typescript
// 使用示例
const { status, error, open, sendFrame, close } = useIat({
  serverBase: 'http://localhost:8083',
  getAuthCode: () => 'your-token',
  onResult: (text, isFinal) => console.log(text)
});
```

### 4. 音频处理模块

#### 音频工具函数
- `toBase64()`: 音频数据编码
- `int16ToFloat32()`: 音频格式转换
- `calculateLevel()`: 音量计算
- `getSharedAudioContext()`: 音频上下文管理

#### AudioWorklet支持
- 高性能音频处理
- 避免主线程阻塞
- 现代浏览器支持

#### 兼容性处理
- ScriptProcessor降级
- 格式转换
- 重采样处理

### 5. 错误处理系统

#### 错误分类
- 网络错误
- 认证错误
- 参数错误
- 系统错误

#### 错误恢复
- 自动重试
- 指数退避
- 连接重建

#### 错误映射
```typescript
const errorMap = {
  10105: '参数错误或鉴权失败',
  10106: '音频格式错误',
  // ... 更多错误码
};
```

## 数据流

### 1. 语音识别流程

```
用户录音 → 音频处理 → WebSocket发送 → 讯飞识别 → 结果回调
    ↓           ↓            ↓           ↓         ↓
  麦克风    格式转换      实时传输      AI处理    界面更新
```

### 2. 语音合成流程

```
文本输入 → 参数配置 → WebSocket发送 → 讯飞合成 → 音频播放
    ↓         ↓           ↓           ↓         ↓
  用户输入   业务参数    实时传输     AI处理    扬声器
```

### 3. 签名获取流程

```
SDK请求 → 后端服务 → 签名生成 → 返回签名 → SDK使用
    ↓        ↓         ↓         ↓        ↓
  前端SDK   Spring Boot  算法计算    HTTP响应   WebSocket连接
```

## 配置管理

### 1. 客户端配置
```typescript
interface BaseXfyunClientOptions {
  serverBase?: string;        // 后端服务地址
  getAuthCode?: () => string; // 认证码获取
  onError?: (message: string) => void; // 错误回调
  onLog?: (level: string, payload: any) => void; // 日志回调
}
```

### 2. 业务参数配置
```typescript
interface IatBusiness {
  language?: string;    // 语种
  domain?: string;      // 业务领域
  accent?: string;      // 方言/口音
  vad_eos?: number;     // 静音断句阈值
  // ... 更多参数
}
```

### 3. 环境配置
- 开发环境: 详细日志、调试信息
- 生产环境: 性能优化、错误监控

## 性能优化

### 1. 音频处理优化
- AudioWorklet异步处理
- 音频数据缓存
- 格式转换优化

### 2. 网络优化
- WebSocket连接复用
- 连接池管理
- 自动重连机制

### 3. 内存管理
- 及时释放资源
- 避免内存泄漏
- 垃圾回收优化

### 4. 并发处理
- 异步操作
- 事件驱动
- 非阻塞I/O

## 安全考虑

### 1. API密钥安全
- 后端统一管理
- 前端不存储密钥
- 签名验证机制

### 2. 数据传输安全
- HTTPS/WSS加密
- 签名验证
- 防重放攻击

### 3. 隐私保护
- 音频数据本地处理
- 不存储用户数据
- 符合隐私法规

## 扩展性设计

### 1. 新功能扩展
- 插件化架构
- 接口标准化
- 向后兼容

### 2. 新框架支持
- 适配器模式
- 统一接口
- 框架无关

### 3. 新服务支持
- 客户端基类
- 配置驱动
- 协议抽象

## 监控和调试

### 1. 日志系统
- 分级日志
- 结构化输出
- 性能监控

### 2. 错误追踪
- 错误分类
- 堆栈信息
- 上下文记录

### 3. 性能监控
- 连接状态
- 音频质量
- 响应时间

## 部署架构

### 1. 前端部署
- CDN分发
- 版本管理
- 缓存策略

### 2. 后端部署
- 容器化部署
- 负载均衡
- 健康检查

### 3. 监控部署
- 日志收集
- 指标监控
- 告警系统

## 未来规划

### 1. 功能扩展
- 更多语音服务
- 离线支持
- 边缘计算

### 2. 性能优化
- WebAssembly支持
- 更高效的音频处理
- 更智能的缓存

### 3. 生态建设
- 更多框架支持
- 插件生态
- 社区贡献

---

本文档会随着项目的发展持续更新，如有疑问或建议，请通过Issue或Pull Request与我们联系。
